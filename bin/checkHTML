#!/bin/bash

VNU_CMD='java -jar node_modules/vnu-jar/build/dist/vnu.jar '

URLS=`lynx -dump http://localhost:8888/aria-role-demos |awk '/http/{print $2}' | grep -v '#' | grep localhost | sort -u`
DOWNLOADED_URLS=""
TEMP_FILES=""


#.. This is the list of files that are to be tested with aXe after a delay of 2000 ms.
AXE_DELAYED_FILES="21-math.php"

echo "Downloading rendered HTML..."

rm tmp/* 2> /dev/null


for i in $URLS
do
	FILE_SLUG=`echo $i| awk -F'/' '{print $NF}'`
	TEMP_FILE="tmp/$FILE_SLUG"

	
	printf "."
	
	wget $i -O $TEMP_FILE 2> /dev/null
	DOWNLOADED_URLS=`echo -e "$DOWNLOADED_URLS\n$i"`
	TEMP_FILES="$TEMP_FILES $TEMP_FILE"
done
echo	
echo "FILES: $TEMP_FILES"
		

echo "Checking HTML..."
echo
OUTPUT=`$VNU_CMD $TEMP_FILES 2>&1 | 
	grep -v autocorrect | 
	grep -v inputmode | 
	grep -v 'The “dialog” element is not supported in all browsers' |
	grep -v 'Bad value “dialog” for attribute “method”' |
	grep -v 'The “button” role is unnecessary' |
	grep -v 'The “role” attribute must not be used on a “td” element' |
	grep -v 'error: When the “srcset” attribute has any image candidate string with a width descriptor, the “sizes” attribute must also be present.' |
	grep -v 'An “img” element which has an “alt” attribute whose value is the empty string must not have a “role” attribute.' |
	grep -v 'info warning:'`
VNU_ERR_CODE="$?"

echo "ERROR CODE: $VNU_ERR_CODE"

# trim output
OUTPUT="${OUTPUT##*( )}"

#.. Let's see if we can get the PHP output into each error to give the dev some context.
READ_RETURN="0"

echo "$OUTPUT" | (
	while [ "$READ_RETURN" = "0" ]
	do
		read LINE
		READ_RETURN="$?"
		
		if [ "$READ_RETURN" = "0" -a "$LINE" != "" ]
		then
			LINES_INFO=`echo $LINE | awk -F':' '{print $3}'`
			BEGIN=`echo $LINES_INFO | awk -F'-' '{print $1}'`
			END=`echo $LINES_INFO | awk -F'-' '{print $2}'`

			BEGIN_LINE_NUM=`echo $BEGIN | awk -F'.' '{print $1}'`
			END_LINE_NUM=`echo $END | awk -F'.' '{print $1}'`

			echo "TEST: $BEGIN $END"
			DIFF_NUM=`expr $END_LINE_NUM - $BEGIN_LINE_NUM + 1`

			FILE=`echo $LINE | awk -F':' '{print $2}' | sed 's/"//g'`
			CONTEXT=`cat $FILE | head -$END_LINE_NUM | tail -$DIFF_NUM`


			# echo "LINES_INFO: $LINES_INFO"
			# echo "LINE_NUM: $BEGIN_LINE_NUM $END_LINE_NUM"
			printf "$LINE\n\n$CONTEXT\n\n"
		fi
	done
)


# echo "$OUTPUT"


OUTPUT_LEN=`echo "$OUTPUT" | wc -c`

if [ "$OUTPUT_LEN" -gt "1" ]
then
	# echo "$OUTPUT"
	rm $TEMP_FILES
	exit
fi

# rm $TEMP_FILES

echo "Running accessibility tests..."


#.. Make a list of the delayed URLS
AXE_DELAYED_URLS=""
AXE_UNDELAYED_URLS="$DOWNLOADED_URLS"
for delayed_file in $AXE_DELAYED_FILES
do
	GREP=`echo "$DOWNLOADED_URLS" | grep $delayed_file`
	AXE_DELAYED_URLS="$AXE_DELAYED_URLS $GREP"
	AXE_UNDELAYED_URLS=`echo "$AXE_UNDELAYED_URLS" | grep -v $delayed_file`
done

axe --exit --load-delay=2000 --chromedriver-path="node_modules/chromedriver/bin/chromedriver" $AXE_DELAYED_URLS
AXE_DELAY_RETURN="$?"

axe --exit --verbose --chromedriver-path="node_modules/chromedriver/bin/chromedriver" $AXE_UNDELAYED_URLS 
AXE_UNDELAY_RETURN="$?"


if [ "$AXE_DELAY_RETURN" -ne "0" -a "$AXE_UNDELAY_RETURN" -ne "0" ]
then
	echo "There are accessibility issues"
	exit 1
fi
